#!/usr/bin/env python3
"""
AI Sessions Sync CLI Manager
=============================
Manage your AI coding session sync to Obsidian.

Commands:
  aisync sync          - Run sync now
  aisync status        - Show sync status
  aisync interval 30   - Set sync interval to 30 minutes
  aisync interval      - Show current interval
  aisync providers     - List all providers
  aisync enable        - Enable background sync
  aisync disable       - Disable background sync
  aisync logs          - Show recent sync logs
"""

import os
import sys
import subprocess
import re
from pathlib import Path
from datetime import datetime

HOME = Path.home()
PLIST_PATH = HOME / "Library/LaunchAgents/com.gokhanturhan.ai-sessions-sync.plist"
CONFIG_PATH = HOME / ".aisync.conf"
LOG_PATH = HOME / ".ai-sessions-sync.log"
SYNC_SCRIPT = HOME / "sync_ai_sessions_to_obsidian.py"

# All available providers
PROVIDERS = [
    ("Claude Code", "sync_claude_code_to_obsidian.py", "~/.claude/projects/"),
    ("Codex CLI", "sync_codex_to_obsidian.py", "~/.codex/"),
    ("Cursor", "sync_cursor_to_obsidian.py", "Cursor projects"),
    ("Aider", "sync_aider_to_obsidian.py", "~/.aider.chat.history.md"),
    ("Cline", "sync_cline_to_obsidian.py", "VS Code globalStorage"),
    ("Gemini CLI", "sync_gemini_cli_to_obsidian.py", "~/.gemini/"),
    ("Continue.dev", "sync_continue_to_obsidian.py", "~/.continue/sessions/"),
    ("GitHub Copilot", "sync_copilot_chat_to_obsidian.py", "VS Code globalStorage"),
    ("Roo Code", "sync_roo_code_to_obsidian.py", "VS Code globalStorage"),
    ("Windsurf", "sync_windsurf_to_obsidian.py", "~/Library/App Support/Windsurf"),
    ("Zed AI", "sync_zed_ai_to_obsidian.py", "~/.config/zed/conversations/"),
    ("Amp", "sync_amp_to_obsidian.py", "VS Code globalStorage"),
]

def get_current_interval():
    """Get current sync interval from plist."""
    if not PLIST_PATH.exists():
        return None
    
    content = PLIST_PATH.read_text()
    match = re.search(r'<key>StartInterval</key>\s*<integer>(\d+)</integer>', content)
    if match:
        return int(match.group(1))
    return None

def set_interval(minutes):
    """Set sync interval in minutes."""
    if not PLIST_PATH.exists():
        print("‚ùå Launchd plist not found. Run 'aisync enable' first.")
        return False
    
    seconds = minutes * 60
    content = PLIST_PATH.read_text()
    
    # Update interval
    new_content = re.sub(
        r'(<key>StartInterval</key>\s*<integer>)\d+(</integer>)',
        f'\\g<1>{seconds}\\g<2>',
        content
    )
    
    PLIST_PATH.write_text(new_content)
    
    # Reload launchd
    subprocess.run(['launchctl', 'unload', str(PLIST_PATH)], 
                   capture_output=True, check=False)
    subprocess.run(['launchctl', 'load', str(PLIST_PATH)], 
                   capture_output=True, check=False)
    
    print(f"‚úÖ Sync interval set to {minutes} minutes ({seconds} seconds)")
    return True

def show_status():
    """Show current sync status."""
    print("üìä AI Sessions Sync Status")
    print("=" * 40)
    
    # Check if launchd agent is loaded
    result = subprocess.run(
        ['launchctl', 'list', 'com.gokhanturhan.ai-sessions-sync'],
        capture_output=True, text=True
    )
    
    if result.returncode == 0:
        print("üü¢ Background sync: ENABLED")
    else:
        print("üî¥ Background sync: DISABLED")
    
    # Show interval
    interval = get_current_interval()
    if interval:
        print(f"‚è±Ô∏è  Sync interval: {interval // 60} minutes")
    
    # Show last sync time from log
    if LOG_PATH.exists():
        lines = LOG_PATH.read_text().strip().split('\n')
        for line in reversed(lines):
            if 'Sync complete' in line:
                print(f"üìÖ Last sync: {line[:19]}")
                break
    
    # Count providers
    active = sum(1 for _, script, _ in PROVIDERS if (HOME / script).exists())
    print(f"üîå Active providers: {active}/{len(PROVIDERS)}")
    
    print()

def list_providers():
    """List all providers and their status."""
    print("üîå AI Session Providers")
    print("=" * 60)
    print(f"{'Provider':<20} {'Script':<35} {'Status':<8}")
    print("-" * 60)
    
    for name, script, location in PROVIDERS:
        script_path = HOME / script
        status = "‚úÖ Ready" if script_path.exists() else "‚ö™ N/A"
        print(f"{name:<20} {script:<35} {status}")
    
    print("-" * 60)
    active = sum(1 for _, script, _ in PROVIDERS if (HOME / script).exists())
    print(f"Total: {active} active providers")
    print()

def run_sync():
    """Run sync now."""
    print("üîÑ Running AI Sessions Sync...")
    print()
    
    result = subprocess.run(
        [sys.executable, str(SYNC_SCRIPT)],
        capture_output=False
    )
    
    return result.returncode == 0

def show_logs(lines=20):
    """Show recent sync logs."""
    if not LOG_PATH.exists():
        print("üìã No logs found yet.")
        return
    
    content = LOG_PATH.read_text().strip().split('\n')
    recent = content[-lines:]
    
    print(f"üìã Recent Sync Logs (last {len(recent)} entries)")
    print("=" * 60)
    for line in recent:
        print(line)
    print()

def enable_sync():
    """Enable background sync."""
    if not PLIST_PATH.exists():
        print("‚ùå Launchd plist not found at:", PLIST_PATH)
        return False
    
    subprocess.run(['launchctl', 'load', str(PLIST_PATH)], check=False)
    print("‚úÖ Background sync enabled")
    return True

def disable_sync():
    """Disable background sync."""
    subprocess.run(['launchctl', 'unload', str(PLIST_PATH)], check=False)
    print("‚úÖ Background sync disabled")
    return True

def show_help():
    """Show help message."""
    print("""
ü§ñ AI Sessions Sync CLI
=======================

Usage: aisync <command> [args]

Commands:
  sync              Run sync immediately
  status            Show current status
  interval [min]    Get or set sync interval (in minutes)
  providers         List all providers
  enable            Enable background sync
  disable           Disable background sync  
  logs [n]          Show last n log entries (default: 20)
  help              Show this help

Examples:
  aisync sync                # Sync now
  aisync interval 5          # Sync every 5 minutes
  aisync interval 30         # Sync every 30 minutes
  aisync logs 50             # Show last 50 log entries
""")

def main():
    args = sys.argv[1:]
    
    if not args or args[0] in ['help', '-h', '--help']:
        show_help()
        return
    
    cmd = args[0].lower()
    
    if cmd == 'sync':
        run_sync()
    elif cmd == 'status':
        show_status()
    elif cmd == 'interval':
        if len(args) > 1:
            try:
                minutes = int(args[1])
                if minutes < 1:
                    print("‚ùå Interval must be at least 1 minute")
                elif minutes > 1440:
                    print("‚ùå Interval cannot exceed 1440 minutes (24 hours)")
                else:
                    set_interval(minutes)
            except ValueError:
                print("‚ùå Invalid interval. Use a number (minutes).")
        else:
            interval = get_current_interval()
            if interval:
                print(f"‚è±Ô∏è  Current sync interval: {interval // 60} minutes ({interval} seconds)")
            else:
                print("‚ö†Ô∏è  Could not determine current interval")
    elif cmd == 'providers':
        list_providers()
    elif cmd == 'enable':
        enable_sync()
    elif cmd == 'disable':
        disable_sync()
    elif cmd == 'logs':
        n = int(args[1]) if len(args) > 1 else 20
        show_logs(n)
    else:
        print(f"‚ùå Unknown command: {cmd}")
        print("Run 'aisync help' for usage.")

if __name__ == "__main__":
    main()
